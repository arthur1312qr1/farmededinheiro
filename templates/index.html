<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETH/USDT Trading Bot - Railway</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { 
            background: var(--bs-dark); 
            color: var(--bs-light);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .trading-card { 
            border-radius: 12px; 
            border: 1px solid var(--bs-border-color-translucent);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        .status-running {
            background-color: #28a745;
        }
        .status-stopped {
            background-color: #dc3545;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .btn-start {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            color: white;
            font-weight: 600;
            padding: 12px 30px;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
            color: white;
        }
        .btn-stop {
            background: linear-gradient(45deg, #dc3545, #e74c3c);
            border: none;
            color: white;
            font-weight: 600;
            padding: 12px 30px;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }
        .btn-stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
            color: white;
        }
        .balance-card {
            background: linear-gradient(135deg, var(--bs-gray-800) 0%, var(--bs-gray-900) 100%);
            border-radius: 12px;
            border: 1px solid var(--bs-border-color-translucent);
        }
        .config-badge {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 6px;
        }
        .profit-positive { color: #28a745; }
        .profit-negative { color: #dc3545; }
        .loading-spinner {
            display: none;
            margin-left: 10px;
        }
        .alert-custom {
            border-radius: 8px;
            border: none;
            font-weight: 500;
        }
        .railway-badge {
            background: linear-gradient(45deg, #8b5cf6, #06b6d4);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container my-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="mb-1"><i class="fas fa-robot me-2"></i>ETH/USDT Trading Bot</h1>
                        <p class="text-muted mb-0">Trading automatizado 24/7 na Bitget</p>
                    </div>
                    <div class="text-end">
                        <span class="railway-badge">Railway Deploy</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alerts -->
        {% if error %}
        <div class="alert alert-danger alert-custom" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
        </div>
        {% endif %}

        <!-- Status Principal e Controles -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card trading-card">
                    <div class="card-header bg-transparent border-0 pb-0">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-line me-2"></i>Controles do Bot
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-3">
                                    <span class="status-indicator {{ 'status-running' if bot_status.running else 'status-stopped' }}"></span>
                                    <strong>Status: </strong>
                                    <span class="ms-2 badge {{ 'bg-success' if bot_status.running else 'bg-secondary' }}">
                                        {{ 'RODANDO' if bot_status.running else 'PARADO' }}
                                    </span>
                                </div>
                                {% if bot_status.uptime %}
                                <small class="text-muted d-block">
                                    <i class="fas fa-clock me-1"></i>Uptime: {{ bot_status.uptime }}
                                </small>
                                {% endif %}
                            </div>
                            <div class="col-md-6 text-md-end">
                                <div class="btn-group" role="group">
                                    {% if not bot_status.running %}
                                    <button id="startBtn" class="btn btn-start">
                                        <i class="fas fa-play me-2"></i>INICIAR BOT
                                        <div class="loading-spinner spinner-border spinner-border-sm" role="status"></div>
                                    </button>
                                    {% else %}
                                    <button id="stopBtn" class="btn btn-stop">
                                        <i class="fas fa-stop me-2"></i>PARAR BOT
                                        <div class="loading-spinner spinner-border spinner-border-sm" role="status"></div>
                                    </button>
                                    {% endif %}
                                    <a href="/dashboard" class="btn btn-outline-info">
                                        <i class="fas fa-chart-bar me-2"></i>Dashboard
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <!-- Saldo -->
                <div class="card balance-card">
                    <div class="card-header bg-transparent border-0 pb-0">
                        <h6 class="card-title mb-0">
                            <i class="fas fa-wallet me-2"></i>Saldo USDT
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if balance_info and not balance_info.error %}
                        <h4 class="mb-2">
                            ${{ "%.2f"|format(balance_info.available_balance) }}
                            {% if balance_info.paper_trading %}
                            <small class="badge bg-info ms-2">PAPER</small>
                            {% endif %}
                        </h4>
                        {% if balance_info.unrealized_pnl %}
                        <small class="d-block {{ 'profit-positive' if balance_info.unrealized_pnl > 0 else 'profit-negative' }}">
                            P&L: ${{ "%.2f"|format(balance_info.unrealized_pnl) }}
                        </small>
                        {% endif %}
                        {% else %}
                        <div class="text-muted">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            {% if balance_info and balance_info.error %}
                            {{ balance_info.error }}
                            {% else %}
                            Carregando...
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Configurações do Bot -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card trading-card">
                    <div class="card-header bg-transparent border-0 pb-0">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-cogs me-2"></i>Configurações
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if config %}
                        <div class="row g-2">
                            <div class="col-6">
                                <small class="text-muted">Modo:</small><br>
                                <span class="badge {{ 'bg-success' if config.real_trading else 'bg-info' }}">
                                    {{ 'REAL' if config.real_trading else 'PAPER' }}
                                </span>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Símbolo:</small><br>
                                <span class="config-badge bg-secondary">{{ config.symbol }}</span>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Leverage:</small><br>
                                <span class="config-badge bg-warning text-dark">{{ config.min_leverage }}x - {{ config.max_leverage }}x</span>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Poll Interval:</small><br>
                                <span class="config-badge bg-info">{{ config.poll_interval }}s</span>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Margin Min:</small><br>
                                <span class="config-badge bg-success">{{ config.min_margin_usage }}%</span>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">API Status:</small><br>
                                <span class="badge {{ 'bg-success' if config.api_keys_configured else 'bg-danger' }}">
                                    {{ 'CONFIGURADA' if config.api_keys_configured else 'PENDENTE' }}
                                </span>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-muted">
                            <i class="fas fa-exclamation-triangle me-2"></i>Erro ao carregar configurações
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Instruções para Railway -->
        {% if config and not config.api_keys_configured %}
        <div class="row">
            <div class="col-12">
                <div class="alert alert-warning alert-custom" role="alert">
                    <h6 class="alert-heading">
                        <i class="fas fa-key me-2"></i>Configuração Necessária
                    </h6>
                    <p class="mb-2">Para iniciar o trading real, configure as seguintes variáveis de ambiente no Railway:</p>
                    <ul class="mb-2">
                        <li><code>BITGET_API_KEY</code> - Sua chave da API Bitget</li>
                        <li><code>BITGET_API_SECRET</code> - Seu secret da API Bitget</li>
                        <li><code>BITGET_PASSPHRASE</code> - Sua passphrase da API Bitget</li>
                    </ul>
                    <small class="text-muted">
                        Enquanto não configurar, o bot funcionará em modo simulação (paper trading).
                    </small>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Footer -->
        <div class="row mt-5">
            <div class="col-12 text-center text-muted">
                <small>
                    <i class="fas fa-server me-2"></i>Rodando 24/7 no Railway
                    <span class="mx-2">|</span>
                    <i class="fas fa-shield-alt me-2"></i>Trading ETH/USDT Futures
                    <span class="mx-2">|</span>
                    <i class="fas fa-chart-line me-2"></i>Bitget Exchange
                </small>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Função para mostrar/esconder loading
        function toggleLoading(button, show) {
            const spinner = button.querySelector('.loading-spinner');
            const icon = button.querySelector('i:not(.loading-spinner i)');
            
            if (show) {
                spinner.style.display = 'inline-block';
                icon.style.display = 'none';
                button.disabled = true;
            } else {
                spinner.style.display = 'none';
                icon.style.display = 'inline';
                button.disabled = false;
            }
        }

        // Função para fazer requisição AJAX
        async function makeRequest(url, method = 'POST') {
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                return await response.json();
            } catch (error) {
                return { error: 'Erro de conexão: ' + error.message };
            }
        }

        // Função para mostrar mensagem
        function showMessage(message, type = 'success') {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
            
            const alertHtml = `
                <div class="alert ${alertClass} alert-custom alert-dismissible fade show" role="alert">
                    <i class="fas ${icon} me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Remove alertas existentes
            const existingAlerts = document.querySelectorAll('.alert-dismissible');
            existingAlerts.forEach(alert => alert.remove());
            
            // Adiciona novo alerta
            const container = document.querySelector('.container');
            container.insertAdjacentHTML('afterbegin', alertHtml);
            
            // Auto-remover após 5 segundos
            setTimeout(() => {
                const alert = document.querySelector('.alert-dismissible');
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }

        // Event listeners para os botões
        document.addEventListener('DOMContentLoaded', function() {
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');

            if (startBtn) {
                startBtn.addEventListener('click', async function() {
                    toggleLoading(this, true);
                    
                    const result = await makeRequest('/api/bot/start');
                    
                    if (result.error) {
                        showMessage('Erro ao iniciar bot: ' + result.error, 'error');
                    } else {
                        showMessage('Bot iniciado com sucesso!');
                        setTimeout(() => location.reload(), 2000);
                    }
                    
                    toggleLoading(this, false);
                });
            }

            if (stopBtn) {
                stopBtn.addEventListener('click', async function() {
                    toggleLoading(this, true);
                    
                    const result = await makeRequest('/api/bot/stop');
                    
                    if (result.error) {
                        showMessage('Erro ao parar bot: ' + result.error, 'error');
                    } else {
                        showMessage('Bot parado com sucesso!');
                        setTimeout(() => location.reload(), 2000);
                    }
                    
                    toggleLoading(this, false);
                });
            }

            // Auto-atualizar status a cada 30 segundos
            setInterval(async function() {
                try {
                    const status = await makeRequest('/api/bot/status', 'GET');
                    if (!status.error) {
                        // Atualizar indicadores visuais sem recarregar a página
                        const statusIndicator = document.querySelector('.status-indicator');
                        const statusBadge = document.querySelector('.badge');
                        
                        if (statusIndicator && statusBadge) {
                            if (status.running) {
                                statusIndicator.className = 'status-indicator status-running';
                                statusBadge.className = 'ms-2 badge bg-success';
                                statusBadge.textContent = 'RODANDO';
                            } else {
                                statusIndicator.className = 'status-indicator status-stopped';
                                statusBadge.className = 'ms-2 badge bg-secondary';
                                statusBadge.textContent = 'PARADO';
                            }
                        }
                    }
                } catch (error) {
                    console.log('Erro ao atualizar status:', error);
                }
            }, 30000);
        });
    </script>
</body>
</html>
