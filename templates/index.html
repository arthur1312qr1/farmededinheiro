<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot de Trading Cripto Aprimorado - Bitget USDT-M Futures</title>
    
    <!-- Bootstrap CSS com tema escuro do Replit (substituído por um tema escuro padrão para melhor compatibilidade) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Custom Styles -->
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        .card {
            background-color: #1e1e1e;
            border-color: #333;
        }
        .card-header {
            border-bottom-color: #333;
        }
        .modal-content {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }
        .form-control, .form-control:focus {
            background-color: #2a2a2a;
            color: #e0e0e0;
            border-color: #444;
        }
    </style>
</head>
<body data-bs-theme="dark">
    <div class="container-fluid">
        <!-- Header -->
        <div class="row">
            <div class="col-12">
                <header class="d-flex flex-wrap justify-content-center py-3 mb-4 border-bottom">
                    <a href="#" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-decoration-none">
                        <i class="fas fa-robot me-2 fs-4 text-primary"></i>
                        <span class="fs-4 text-white">Enhanced Crypto Trading Bot</span>
                    </a>
                    <div class="d-flex align-items-center">
                        <!-- Bot status badge -->
                        <span id="bot-status-badge" class="badge me-2">
                            <i class="fas"></i>
                            <span></span>
                        </span>
                        <!-- Paper trading badge -->
                        <span id="paper-trading-badge" class="badge bg-warning" style="display: none;">
                            <i class="fas fa-vial"></i> PAPER TRADING
                        </span>
                    </div>
                </header>
            </div>
        </div>

        <!-- Flash Messages -->
        <div class="row">
            <div class="col-12">
                <div id="flash-messages">
                    <!-- Flash messages will be dynamically added here -->
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>Painel de Controle
                        </h5>
                        <small class="text-muted">Bitget Futures USDT-M</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-grid gap-2 d-md-flex">
                                    <button id="start-bot-btn" type="button" class="btn btn-success">
                                        <i class="fas fa-play"></i> Iniciar Bot
                                    </button>
                                    <button id="stop-bot-btn" type="button" class="btn btn-danger">
                                        <i class="fas fa-stop"></i> Parar Bot
                                    </button>
                                    <button id="refresh-btn" type="button" class="btn btn-info">
                                        <i class="fas fa-sync"></i> Atualizar
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6 text-md-end">
                                <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#aiAnalysisModal">
                                    <i class="fas fa-magic"></i> Análise IA de Erros
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Dashboard -->
        <div class="row mb-4">
            <!-- Balance Information -->
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-wallet text-primary"></i> Saldo & Patrimônio
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="balance-info">
                            <!-- Data will be populated here by JavaScript -->
                            <div class="text-muted text-center">
                                <i class="fas fa-spinner fa-spin"></i> Carregando...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trading Statistics -->
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-line text-success"></i> Estatísticas de Trading
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="trading-stats">
                            <!-- Data will be populated here by JavaScript -->
                            <div class="text-muted text-center">
                                <i class="fas fa-spinner fa-spin"></i> Carregando...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration -->
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-cog text-warning"></i> Configuração
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="config-info">
                            <!-- Data will be populated here by JavaScript -->
                            <div class="text-muted text-center">
                                <i class="fas fa-spinner fa-spin"></i> Carregando...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Positions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-chart-area text-info"></i> Posições Atuais
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="positions-table">
                            <!-- Data will be populated here by JavaScript -->
                            <div class="text-muted text-center py-3">
                                <i class="fas fa-spinner fa-spin"></i> Carregando posições...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot State & Logs -->
        <div class="row mb-4">
            <!-- Bot State -->
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-database text-secondary"></i> Estado do Bot
                        </h6>
                    </div>
                    <div class="card-body">
                        <pre id="bot-state" class="bg-dark p-3 rounded text-light small" style="max-height: 300px; overflow-y: auto;">
                            Carregando estado do bot...
                        </pre>
                    </div>
                </div>
            </div>

            <!-- Recent Logs -->
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-file-alt text-secondary"></i> Atividade Recente
                        </h6>
                    </div>
                    <div class="card-body">
                        <pre id="recent-logs" class="bg-dark p-3 rounded text-light small" style="max-height: 300px; overflow-y: auto;">
                            Carregando logs...
                        </pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Analysis Modal -->
        <div class="modal fade" id="aiAnalysisModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-magic text-warning"></i> Análise Gemini IA
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="ai-analysis-loading" class="text-center py-3" style="display: none;">
                            <i class="fas fa-spinner fa-spin me-2"></i> Análise em andamento...
                        </div>
                        <div class="mb-3">
                            <label for="errorDescription" class="form-label">Descrição do Erro</label>
                            <textarea class="form-control" id="errorDescription" rows="3" placeholder="Descreva o erro ou problema que está enfrentando..."></textarea>
                        </div>
                        <div id="aiAnalysisResult" class="border rounded p-3 bg-dark text-light" style="display: none;">
                            <h6>Resultado da Análise da IA:</h6>
                            <pre id="aiResultText" class="mb-0"></pre>
                        </div>
                        <div id="ai-analysis-error" class="alert alert-danger mt-3" role="alert" style="display: none;">
                            <!-- Error message will be populated here -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        <button type="button" class="btn btn-warning" onclick="requestAiAnalysis()">
                            <i class="fas fa-magic"></i> Analisar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="py-4 mt-5 border-top">
            <div class="row">
                <div class="col-md-6">
                    <p class="text-muted mb-0">
                        <i class="fas fa-shield-alt text-success"></i> 
                        Bot de Trading Aprimorado com Análise de Erros da Gemini IA
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <small class="text-muted">
                        Última atualização: <span id="last-update">Nunca</span>
                    </small>
                </div>
            </div>
        </footer>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Mock data to simulate server responses
        let mockBotState = {
            bot_running: false,
            paper_trading: true,
            total_profit: 15.75,
            total_trades: 12,
            winning_trades: 8,
            losing_trades: 4,
            current_positions: {
                long: {
                    side: "long",
                    size: 0.05,
                    entry_price: 65000.50,
                    unrealized_pnl: 1.25,
                    leverage: 10
                },
                // short: {
                //     side: "short",
                //     size: 0.1,
                //     entry_price: 67000.00,
                //     unrealized_pnl: -0.50,
                //     leverage: 5
                // }
            },
            last_updated: new Date().toLocaleString(),
        };

        let mockBalanceInfo = {
            available_balance: 500.00,
            total_equity: 515.75,
            unrealized_pnl: 1.25,
        };
        
        let mockConfig = {
            SYMBOL: 'BTCUSDT',
            MIN_LEVERAGE: 5,
            MAX_LEVERAGE: 20,
            POLL_INTERVAL: 5,
            MAX_CONSECUTIVE_LOSSES: 3,
        };

        let mockLogs = [
            '2025-08-10 22:00:00 - INFO - Bot started.',
            '2025-08-10 22:01:15 - TRADE - Opened LONG position on BTCUSDT at $65000.50.',
            '2025-08-10 22:05:30 - UPDATE - Unrealized P&L is now $1.25.',
        ];

        // Functions to update the UI
        function updateAllUI() {
            updateHeader(mockBotState);
            updateBalanceInfo(mockBalanceInfo);
            updateTradingStats(mockBotState);
            updateConfig(mockConfig);
            updatePositionsTable(mockBotState);
            updateBotState(mockBotState);
            updateLogs(mockLogs);
            document.getElementById('last-update').textContent = new Date().toLocaleString();
        }

        function updateHeader(state) {
            const statusBadge = document.getElementById('bot-status-badge');
            const paperTradingBadge = document.getElementById('paper-trading-badge');
            
            if (state.bot_running) {
                statusBadge.className = 'badge bg-success me-2';
                statusBadge.querySelector('i').className = 'fas fa-play';
                statusBadge.querySelector('span').textContent = 'RODANDO';
            } else {
                statusBadge.className = 'badge bg-danger me-2';
                statusBadge.querySelector('i').className = 'fas fa-stop';
                statusBadge.querySelector('span').textContent = 'PARADO';
            }

            if (state.paper_trading) {
                paperTradingBadge.style.display = 'block';
            } else {
                paperTradingBadge.style.display = 'none';
            }
        }

        function updateBotState(state) {
            const stateElement = document.getElementById('bot-state');
            stateElement.textContent = JSON.stringify(state, null, 2);
        }

        function updateBalanceInfo(balance) {
            const balanceElement = document.getElementById('balance-info');
            const unrealizedPnlClass = parseFloat(balance.unrealized_pnl || 0) >= 0 ? 'text-success' : 'text-danger';
            
            balanceElement.innerHTML = `
                <div class="mb-2">
                    <small class="text-muted">Saldo Disponível</small>
                    <div class="fs-5 fw-bold text-primary">
                        $${parseFloat(balance.available_balance || 0).toFixed(2)}
                    </div>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Patrimônio Total</small>
                    <div class="fs-6">
                        $${parseFloat(balance.total_equity || 0).toFixed(2)}
                    </div>
                </div>
                <div class="mb-2">
                    <small class="text-muted">P&L Não Realizado</small>
                    <div class="fs-6 ${unrealizedPnlClass}">
                        $${parseFloat(balance.unrealized_pnl || 0).toFixed(2)}
                    </div>
                </div>
            `;
        }

        function updateTradingStats(state) {
            const statsElement = document.getElementById('trading-stats');
            const totalTrades = (state.winning_trades || 0) + (state.losing_trades || 0);
            const winRate = totalTrades > 0 ? ((state.winning_trades || 0) / totalTrades * 100).toFixed(1) : 'N/A';
            const totalProfitClass = parseFloat(state.total_profit || 0) >= 0 ? 'text-success' : 'text-danger';
            
            statsElement.innerHTML = `
                <div class="mb-2">
                    <small class="text-muted">Lucro Total</small>
                    <div class="fs-5 fw-bold ${totalProfitClass}">
                        $${parseFloat(state.total_profit || 0).toFixed(2)}
                    </div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <small class="text-muted">Total de Trades</small>
                        <div class="fw-bold">${state.total_trades || 0}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Taxa de Vitórias</small>
                        <div class="fw-bold">
                            ${winRate}${winRate !== 'N/A' ? '%' : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function updateConfig(config) {
            const configElement = document.getElementById('config-info');
            configElement.innerHTML = `
                <div class="mb-2">
                    <small class="text-muted">Símbolo</small>
                    <div class="fw-bold">${config.SYMBOL || 'N/A'}</div>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Alavancagem</small>
                    <div>${config.MIN_LEVERAGE || 'N/A'}x - ${config.MAX_LEVERAGE || 'N/A'}x</div>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Intervalo de Sondagem</small>
                    <div>${config.POLL_INTERVAL || 'N/A'}s</div>
                </div>
                <div class="mb-2">
                    <small class="text-muted">Perdas Máximas</small>
                    <div>${config.MAX_CONSECUTIVE_LOSSES || 'N/A'}</div>
                </div>
            `;
        }

        function updatePositionsTable(state) {
            const positionsElement = document.getElementById('positions-table');
            const positions = state.current_positions || {};
            
            if (Object.keys(positions).length === 0) {
                positionsElement.innerHTML = `
                    <div class="text-muted text-center py-3">
                        <i class="fas fa-inbox"></i> Nenhuma posição aberta.
                    </div>
                `;
            } else {
                let html = '<div class="table-responsive"><table class="table table-dark table-striped"><thead><tr>';
                html += '<th>Lado</th><th>Tamanho</th><th>Preço de Entrada</th><th>P&L Não Realizado</th><th>Alavancagem</th></tr></thead><tbody>';
                
                for (const side in positions) {
                    const position = positions[side];
                    const sideBadgeClass = side === 'long' ? 'bg-success' : 'bg-danger';
                    const pnlClass = parseFloat(position.unrealized_pnl || 0) >= 0 ? 'text-success' : 'text-danger';
                    
                    html += `<tr>
                        <td><span class="badge ${sideBadgeClass}">${side.toUpperCase()}</span></td>
                        <td>${parseFloat(position.size || 0).toFixed(4)}</td>
                        <td>$${parseFloat(position.entry_price || 0).toFixed(2)}</td>
                        <td class="${pnlClass}">
                            $${parseFloat(position.unrealized_pnl || 0).toFixed(2)}
                        </td>
                        <td>${position.leverage || 'N/A'}x</td>
                    </tr>`;
                }
                
                html += '</tbody></table></div>';
                positionsElement.innerHTML = html;
            }
        }
        
        function updateLogs(logs) {
            const logsElement = document.getElementById('recent-logs');
            logsElement.textContent = logs.join('\n');
            logsElement.scrollTop = logsElement.scrollHeight;
        }

        function requestAiAnalysis() {
            const errorDescription = document.getElementById('errorDescription').value;
            const resultDiv = document.getElementById('aiAnalysisResult');
            const resultText = document.getElementById('aiResultText');
            const loadingDiv = document.getElementById('ai-analysis-loading');
            const errorDiv = document.getElementById('ai-analysis-error');
            
            if (!errorDescription.trim()) {
                errorDiv.textContent = 'Por favor, insira uma descrição do erro.';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Hide previous results and errors, show loading
            resultDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            loadingDiv.style.display = 'block';

            // Simulate the AI analysis
            setTimeout(() => {
                loadingDiv.style.display = 'none';
                // Mock response from AI
                const mockResponse = {
                    fix_suggestion: `A análise da IA sugere que o erro pode estar relacionado à conexão com a API da Bitget. Verifique se as suas chaves de API estão corretas e se o bot tem permissão para acessar a conta.`,
                    success: true
                };

                if (mockResponse.success) {
                    resultText.textContent = mockResponse.fix_suggestion;
                    resultDiv.style.display = 'block';
                } else {
                    errorDiv.textContent = `Erro da API: ${mockResponse.error}`;
                    errorDiv.style.display = 'block';
                }
            }, 2000); // Simulate a 2-second API call
        }

        // Event listeners for buttons
        document.getElementById('start-bot-btn').addEventListener('click', () => {
            // In a real application, this would make a POST request to start the bot
            mockBotState.bot_running = true;
            updateAllUI();
            showFlashMessage('success', 'Bot iniciado com sucesso!');
        });
        
        document.getElementById('stop-bot-btn').addEventListener('click', () => {
            // In a real application, this would make a POST request to stop the bot
            mockBotState.bot_running = false;
            updateAllUI();
            showFlashMessage('danger', 'Bot parado.');
        });
        
        document.getElementById('refresh-btn').addEventListener('click', updateAllUI);

        function showFlashMessage(category, message) {
            const flashContainer = document.getElementById('flash-messages');
            const categoryClass = category === 'error' ? 'danger' : category;
            const iconClass = category === 'error' ? 'exclamation-circle' : category === 'info' ? 'info-circle' : 'check-circle';
            const html = `
                <div class="alert alert-${categoryClass} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${iconClass} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            flashContainer.innerHTML = html;
        }

        // Initial load and periodic updates
        updateAllUI();
        setInterval(updateAllUI, mockConfig.POLL_INTERVAL * 1000);

    </script>
</body>
</html>
