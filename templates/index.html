<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Bot Dashboard</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #2c3e50; color: #ecf0f1; }
        .card { background-color: #34495e; border-color: #34495e; color: #ecf0f1; }
        .list-group-item { background-color: #34495e; border-color: #495e74; color: #ecf0f1; }
        .log-container { max-height: 300px; overflow-y: scroll; background-color: #233140; padding: 1rem; border-radius: 5px; }
        .log-item { border-bottom: 1px solid #495e74; padding: 5px 0; }
        .log-item:last-child { border-bottom: none; }
        .status-running { color: #2ecc71; }
        .status-stopped { color: #e74c3c; }
        .status-pending { color: #f1c40f; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4 text-warning">Trading Bot Dashboard</h1>
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4>Status do Bot</h4>
                        <span id="botStatus" class="badge badge-pill badge-warning">Carregando...</span>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between">
                                Preço Atual ETHUSDT: <span id="currentPrice" class="font-weight-bold">--</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                Saldo da Conta: <span id="currentBalance" class="font-weight-bold">--</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                Modo de Negociação: <span id="tradingMode" class="font-weight-bold">--</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h4>Estatísticas de Desempenho</h4>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between">
                                Trades Totais: <span id="tradeCount" class="font-weight-bold">0</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                Trades Ganhos: <span id="winRate" class="font-weight-bold">0%</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                Lucro Total (PNL): <span id="pnl" class="font-weight-bold">$0.00</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h4>Log de Eventos</h4>
            </div>
            <div class="card-body log-container" id="logContainer">
                </div>
        </div>

        <div class="mt-4 text-center">
            <button id="startButton" class="btn btn-success btn-lg mx-2">Iniciar Bot</button>
            <button id="stopButton" class="btn btn-danger btn-lg mx-2">Parar Bot</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const socket = io();
        const logContainer = document.getElementById('logContainer');

        const botStatusElem = document.getElementById('botStatus');
        const currentPriceElem = document.getElementById('currentPrice');
        const currentBalanceElem = document.getElementById('currentBalance');
        const tradingModeElem = document.getElementById('tradingMode');
        const tradeCountElem = document.getElementById('tradeCount');
        const winRateElem = document.getElementById('winRate');
        const pnlElem = document.getElementById('pnl');

        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');

        function appendLog(message, type) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            const logItem = document.createElement('div');
            logItem.className = `log-item text-${type}`;
            logItem.textContent = `[${timeStr}] ${message}`;
            logContainer.prepend(logItem); // Adiciona no topo
            if (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild); // Limita o número de logs
            }
        }

        // Handle Socket.IO events
        socket.on('bot_status', function(data) {
            const status = data.status;
            if (status === 'started') {
                botStatusElem.textContent = 'RODANDO';
                botStatusElem.className = 'badge badge-pill badge-success status-running';
                startButton.disabled = true;
                stopButton.disabled = false;
                appendLog('Bot iniciado e operando.', 'success');
            } else if (status === 'stopped') {
                botStatusElem.textContent = 'PARADO';
                botStatusElem.className = 'badge badge-pill badge-danger status-stopped';
                startButton.disabled = false;
                stopButton.disabled = true;
                appendLog('Bot parado.', 'danger');
            } else if (status === 'connected') {
                appendLog('Conectado ao servidor.', 'info');
            }
        });

        socket.on('price_update', function(data) {
            currentPriceElem.textContent = `$${data.price.toFixed(2)}`;
        });

        socket.on('balance_update', function(data) {
            currentBalanceElem.textContent = `$${data.balance.toFixed(2)}`;
            tradingModeElem.textContent = data.mode.toUpperCase();
        });
        
        socket.on('trade_executed', function(data) {
            appendLog(`Trade EXECUTADO: ${data.side.toUpperCase()} ${data.size.toFixed(4)} @ $${data.price.toFixed(2)}`, 'info');
            // Atualizar stats via API
            fetch('/api/bot/status')
                .then(r => r.json())
                .then(stats => {
                    if (stats.success) {
                        tradeCountElem.textContent = stats.data.total_trades;
                        winRateElem.textContent = `${stats.data.win_rate}%`;
                        pnlElem.textContent = `$${stats.data.total_pnl.toFixed(2)}`;
                    }
                });
        });

        socket.on('analysis_update', function(data) {
            const confidence = data.technical.confidence * 100;
            appendLog(`Análise técnica: ${data.technical.action.toUpperCase()} com ${confidence.toFixed(1)}% de confiança.`, 'secondary');
        });

        socket.on('log_message', function(data) {
            appendLog(data.message, data.type || 'light');
        });

        // Functions to load initial data
        function loadInitialData() {
            fetch('/api/bot/status')
                .then(r => r.json())
                .then(stats => {
                    if (stats.success) {
                        tradeCountElem.textContent = stats.data.total_trades;
                        winRateElem.textContent = `${stats.data.win_rate}%`;
                        pnlElem.textContent = `$${stats.data.total_pnl.toFixed(2)}`;
                        socket.emit('bot_status', { status: stats.data.is_running ? 'started' : 'stopped' });
                    }
                });
            
            fetch('/api/balance')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        currentBalanceElem.textContent = `$${data.data.available.toFixed(2)}`;
                        tradingModeElem.textContent = data.data.mode.toUpperCase();
                    }
                });
            
            fetch('/api/price/ETHUSDT_UMCBL')
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        currentPriceElem.textContent = `$${data.price.toFixed(2)}`;
                    }
                });
        }
        
        // Event listeners for buttons
        startButton.addEventListener('click', () => {
            fetch('/api/bot/start', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        appendLog('Comando de iniciar bot enviado.', 'info');
                    } else {
                        appendLog('Erro ao iniciar bot.', 'danger');
                    }
                });
        });

        stopButton.addEventListener('click', () => {
            fetch('/api/bot/stop', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        appendLog('Comando de parar bot enviado.', 'info');
                    } else {
                        appendLog('Erro ao parar bot.', 'danger');
                    }
                });
        });

        // Load data on page load
        loadInitialData();
    </script>
</body>
</html>
