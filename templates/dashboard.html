<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ETH/USDT Trading Bot</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { 
            background: var(--bs-dark); 
            color: var(--bs-light);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .stat-card {
            border-radius: 12px;
            border: 1px solid var(--bs-border-color-translucent);
            background: linear-gradient(135deg, var(--bs-gray-800) 0%, var(--bs-gray-900) 100%);
            transition: transform 0.2s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
        }
        .profit-positive { color: #28a745; }
        .profit-negative { color: #dc3545; }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        .status-running { background-color: #28a745; }
        .status-stopped { background-color: #dc3545; }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .back-btn {
            background: linear-gradient(45deg, var(--bs-secondary), var(--bs-gray-700));
            border: none;
            color: white;
            padding: 8px 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .back-btn:hover {
            transform: translateY(-1px);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container-fluid my-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="mb-1">
                            <i class="fas fa-chart-bar me-2"></i>Dashboard de Trading
                        </h1>
                        <p class="text-muted mb-0">
                            <span class="status-indicator {{ 'status-running' if bot_status.running else 'status-stopped' }}"></span>
                            Bot {{ 'ativo' if bot_status.running else 'inativo' }} - ETH/USDT Futures
                        </p>
                    </div>
                    <div>
                        <a href="/" class="btn back-btn">
                            <i class="fas fa-arrow-left me-2"></i>Voltar
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cards de Estatísticas -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-line fa-2x text-primary mb-3"></i>
                        <h6 class="card-title text-muted">Total de Trades</h6>
                        <div class="stat-value text-info">
                            {{ trading_stats.total_trades or 0 }}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-percentage fa-2x text-success mb-3"></i>
                        <h6 class="card-title text-muted">Taxa de Acerto</h6>
                        <div class="stat-value text-success">
                            {{ "%.1f"|format(trading_stats.win_rate or 0) }}%
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-dollar-sign fa-2x {{ 'text-success' if (trading_stats.total_profit or 0) >= 0 else 'text-danger' }} mb-3"></i>
                        <h6 class="card-title text-muted">P&L Total</h6>
                        <div class="stat-value {{ 'profit-positive' if (trading_stats.total_profit or 0) >= 0 else 'profit-negative' }}">
                            ${{ "%.2f"|format(trading_stats.total_profit or 0) }}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card">
                    <div class="card-body text-center">
                        <i class="fas fa-wallet fa-2x text-warning mb-3"></i>
                        <h6 class="card-title text-muted">Saldo Disponível</h6>
                        <div class="stat-value text-warning">
                            ${{ "%.2f"|format(balance_info.available_balance or 0) }}
                        </div>
                        {% if balance_info.paper_trading %}
                        <small class="badge bg-info mt-1">PAPER</small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos e Detalhes -->
        <div class="row mb-4">
            <!-- Gráfico de Performance -->
            <div class="col-lg-8 mb-3">
                <div class="card">
                    <div class="card-header bg-transparent border-0">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-area me-2"></i>Performance do Saldo
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="balanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estatísticas Detalhadas -->
            <div class="col-lg-4 mb-3">
                <div class="card">
                    <div class="card-header bg-transparent border-0">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-info-circle me-2"></i>Detalhes
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <small class="text-muted">Trades Ganhos</small>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-success">{{ trading_stats.winning_trades or 0 }}</span>
                                <div class="progress flex-grow-1 ms-2" style="height: 8px;">
                                    <div class="progress-bar bg-success" style="width: {{ (trading_stats.win_rate or 0) }}%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <small class="text-muted">Trades Perdidos</small>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-danger">{{ trading_stats.losing_trades or 0 }}</span>
                                <div class="progress flex-grow-1 ms-2" style="height: 8px;">
                                    <div class="progress-bar bg-danger" style="width: {{ (100 - (trading_stats.win_rate or 0)) }}%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <small class="text-muted">Perdas Consecutivas</small>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge {{ 'bg-danger' if (trading_stats.consecutive_losses or 0) >= 3 else 'bg-secondary' }}">
                                    {{ trading_stats.consecutive_losses or 0 }}
                                </span>
                            </div>
                        </div>

                        <hr class="my-3">

                        <div class="mb-2">
                            <small class="text-muted">Uptime</small>
                            <div class="text-info">{{ bot_status.uptime or 'N/A' }}</div>
                        </div>

                        <div class="mb-2">
                            <small class="text-muted">Último Trade</small>
                            <div class="small">
                                {% if trading_stats.last_trade_time %}
                                {{ trading_stats.last_trade_time[:19] | replace('T', ' ') }}
                                {% else %}
                                Nenhum trade ainda
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configurações do Sistema -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-transparent border-0">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-cogs me-2"></i>Configurações do Sistema
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2 col-6 mb-3">
                                <small class="text-muted">Modo</small>
                                <div>
                                    <span class="badge {{ 'bg-success' if config.real_trading else 'bg-info' }}">
                                        {{ 'REAL' if config.real_trading else 'PAPER' }}
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-2 col-6 mb-3">
                                <small class="text-muted">Símbolo</small>
                                <div class="fw-bold">{{ config.symbol }}</div>
                            </div>
                            <div class="col-md-2 col-6 mb-3">
                                <small class="text-muted">Leverage</small>
                                <div class="fw-bold text-warning">{{ config.min_leverage }}x - {{ config.max_leverage }}x</div>
                            </div>
                            <div class="col-md-2 col-6 mb-3">
                                <small class="text-muted">Poll Interval</small>
                                <div class="fw-bold text-info">{{ config.poll_interval }}s</div>
                            </div>
                            <div class="col-md-2 col-6 mb-3">
                                <small class="text-muted">Margem Min</small>
                                <div class="fw-bold text-success">{{ config.min_margin_usage }}%</div>
                            </div>
                            <div class="col-md-2 col-6 mb-3">
                                <small class="text-muted">API Status</small>
                                <div>
                                    <span class="badge {{ 'bg-success' if config.api_keys_configured else 'bg-danger' }}">
                                        {{ 'OK' if config.api_keys_configured else 'ERRO' }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="row mt-4">
            <div class="col-12 text-center text-muted">
                <small>
                    <i class="fas fa-server me-2"></i>Railway Deploy
                    <span class="mx-2">|</span>
                    <i class="fas fa-sync me-2"></i>Auto-refresh a cada 30s
                    <span class="mx-2">|</span>
                    <i class="fas fa-shield-alt me-2"></i>Bitget Exchange
                </small>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Configuração do Chart.js para tema dark
        Chart.defaults.color = '#adb5bd';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

        // Inicializar gráfico de saldo
        const balanceChartCtx = document.getElementById('balanceChart').getContext('2d');
        
        // Dados do histórico de saldo
        const balanceHistory = {{ trading_stats.balance_history | tojson }};
        const chartLabels = balanceHistory.map((item, index) => `${index + 1}`);
        const chartData = balanceHistory.map(item => parseFloat(item.balance || 0));

        // Se não houver dados, criar dados simulados
        if (chartData.length === 0) {
            chartLabels.push('1');
            chartData.push({{ balance_info.available_balance or 1000 }});
        }

        const balanceChart = new Chart(balanceChartCtx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Saldo USDT',
                    data: chartData,
                    borderColor: '#17a2b8',
                    backgroundColor: 'rgba(23, 162, 184, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#17a2b8',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(33, 37, 41, 0.9)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: '#17a2b8',
                        borderWidth: 1,
                        displayColors: false,
                        callbacks: {
                            title: function(context) {
                                return 'Ponto ' + context[0].label;
                            },
                            label: function(context) {
                                return 'Saldo: $' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        title: {
                            display: true,
                            text: 'Histórico de Pontos'
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        },
                        title: {
                            display: true,
                            text: 'Saldo (USDT)'
                        },
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });

        // Auto-refresh da página a cada 30 segundos
        let refreshInterval = setInterval(function() {
            // Fazer requisição AJAX para atualizar dados sem recarregar completamente
            fetch('/api/bot/status')
                .then(response => response.json())
                .then(data => {
                    if (!data.error) {
                        // Atualizar indicador de status
                        const statusIndicator = document.querySelector('.status-indicator');
                        if (statusIndicator) {
                            statusIndicator.className = `status-indicator ${data.running ? 'status-running' : 'status-stopped'}`;
                        }
                    }
                })
                .catch(error => console.log('Erro ao atualizar status:', error));
        }, 30000);

        // Limpar interval ao sair da página
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });

        // Adicionar responsividade ao gráfico
        window.addEventListener('resize', function() {
            if (balanceChart) {
                balanceChart.resize();
            }
        });
    </script>
</body>
</html>
